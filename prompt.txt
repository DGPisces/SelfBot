你是一位 **SWE**，目标是把一个想法尽快落成**能跑起来**的版本，并且后续好维护、好扩展。这个项目叫 **SelfBot**：通过学习用户平时的聊天语料，让机器人在 **Discord** 里**模仿用户语气**自动回复。首个版本只处理 **文字** 和 **语音**（语音先转成文字），收到图片时要礼貌提示对方改用文字描述（不做 OCR / 图像理解）。

我将使用 **Ollama** 作为运行模型的框架（本地/自托管）。你的实现必须能通过 Ollama 调用模型来生成回复（例如 HTTP API），并且要能配置不同“风格模型”或同一模型不同风格配置。

---

# 0) 最终交付要求（硬性）

* 产出内容要像真实工程交付：**复制成文件 → 安装依赖 → 配好 env → docker 一键启动 → 能在 Discord 里跑起来**。
* 回复要自然，但要避免刷屏：要有**限流、防重复、随机延迟、typing indicator**。
* 不要在用户可见回复里暴露内部调试信息（比如 routing reason、prompt、模型输出原文等）。
* 要考虑隐私：日志、导出数据、训练数据都要有基本脱敏（手机号/邮箱/地址/证件号/银行卡等）。

---

# 1) 我们要达成的功能目标

1. **Discord bot**

* 监听指定服务器/频道的消息与私信（DM），支持配置白名单/黑名单（server/channel/user）。
* 只在授权范围内工作，避免干扰未授权频道/用户。
* 支持 slash commands 管理开关与配置。

2. **自动回复 + 多轮对话**

* 保留会话上下文（按频道/按用户/按线程可配置一个策略）。
* 支持多轮对话，不要每次都像“第一次见面”。

3. **多风格人格（多模型体系）**

* 内置多个风格：理工/温柔/毒舌/正式（至少 4 个）。
* 支持两种选择方式：

  * **自动**：通过“路由器”决定当前用哪个风格（输出 style_id + confidence + reason，仅用于日志调试）。
  * **手动**：管理员/用户可指定固定风格（覆盖自动路由）。
* 风格输出要像人：短句、自然断句、可配置 emoji 密度；但不要极端口癖或奇怪的过拟合。

4. **语音支持**

* Discord 语音消息：以“语音附件/语音消息文件/可获取的 voice message”形式接入（如果 Discord 原生 voice message 获取受限，给出可行替代并实现默认支持的那一种）。
* 语音必须先 ASR 转写成文本，再走同一条消息 pipeline。
* ASR 要可插拔：先做可运行占位实现（例如基于本地 whisper/或 HTTP ASR 服务），但接口要清晰，后续容易换。

5. **可部署与可运维**

* 必须提供 Docker 支持（Dockerfile + docker-compose.yml）。
* 日志直出到 stdout，便于 docker logs 观察。
* 默认非 root 用户运行（尽量做到）。

6. 网页管理
* 我希望有一个网页可以管理使用的模型等相关功能

3) 预期效果（验收标准 / 用户体验目标）

请按下面的“预期效果”来实现并自测，最终交付要能满足这些行为：

3.1 Discord 端体验

在未授权服务器/频道/用户：SelfBot 不响应（也不报错刷屏），日志记录为“被策略拦截”。

在授权范围内：

用户发文字消息 → bot 显示 typing → 随机延迟（可配置）→ 回复一条自然消息

支持多轮：连续对话时回复会引用上下文，不会每次都像首次对话

同一条消息/相似消息短时间重复出现时：bot 不会疯狂重复回复（去重生效）

触发限流时：bot 暂停回复，必要时给一次“我稍后再回”的温和提示（可配置是否提示）

3.2 图片消息策略

用户发图片/纯附件（无文字）：bot 礼貌提示“我暂不支持图片，请用文字描述”，且不会尝试 OCR。

用户发“文字 + 图片”：只用文字内容进入 pipeline，必要时提醒“图片内容我看不到”。

3.3 语音消息策略

用户发送语音附件/语音消息文件：

bot 提示正在处理（typing 或短提示均可）

ASR 成功：使用转写文本进入对话 pipeline 并回复

ASR 失败：给出温和失败提示（不暴露内部错误），并在日志中记录原因

3.4 多风格与路由

默认开启自动路由：不同语境能切换合适风格（至少能看出差异）

当路由置信度低：会 fallback 到默认温和中性风格

手动指定风格后：该范围内（例如 guild/channel 级别）优先使用手动风格，除非切回 auto

3.5 Web Admin 管理

管理员能在网页上：

开关 bot（on/off）

修改风格配置并立即生效（无需重启，或提供可控热加载）

修改白/黑名单与限流参数并立即生效

查看最近路由决策与错误日志（仅后台可见）

导出脱敏后的对话数据（并写入审计记录）

3.6 Docker 一键启动

docker compose up -d 后：

Discord bot 正常在线

Web Admin 可访问（默认本地绑定或带鉴权）

日志可通过 docker logs 看到

关闭/重启后配置与上下文按预期持久化（如果你选择持久化存储）

4) 输出要求补充（避免跑偏）

在你输出交付物时：

Web Admin 必须包含：页面 + API + 鉴权 + docker（最简可用即可，不要做成大而全的前端工程）

不要把内部 reason/prompt 暴露到 Discord 回复中，但允许在 Web Admin 的受控页面查看

对外暴露端口、鉴权方式、默认绑定地址，都要在配置示例和部署说明里写清楚